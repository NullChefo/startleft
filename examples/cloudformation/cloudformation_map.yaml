trustzones:
  - id:          {$format: "{name}"}
    type:        {$path: "Type"}
    $source:     {$root: "Resources|squash(@)[?Type=='AWS::EC2::VPC']"}
    name:        {$path: "_key"}

components:
  - id:          {$format: "{name}"}
    type:        {$path: "Type"}
    name:        {$path: "_key"}
    $source:     {$root: "Resources|squash(@)[?Type=='AWS::EC2::Subnet']"}
    parent:      {$path: "Properties.VpcId.Ref"}

  - id:          {$format: "{name}-{parent}"}
    type:        {$path: "Type"}
    $source:     {$root: "Resources|squash(@)[?Type=='AWS::ElasticLoadBalancingV2::LoadBalancer']"}
    name:        {$path: "_key"}
    parent:      {$path: "Properties.Subnets[]|map(&values(@), @)[]|map(&re_sub('[:]', '-', @), @)"}

  - id:          {$format: "{name}"}
    type:        {$path: "Type"}
    name:        {$path: "_key"}
    $source:     {$root: "Resources|squash(@)[?Type=='AWS::Route53::HostedZone']"}
    parent:      {$path: "Properties.VPCs[].VPCId|map(&values(@), @)[]|map(&re_sub('[:]', '-', @), @)"}

  - id:          {$format: "{name}"}
    type:        {$path: "Type"}
    name:        {$path: "_key"}
    $source:     {$root: "Resources|squash(@)[?Type=='AWS::Route53::RecordSet']"}
    parent:      {$path: "Properties.HostedZoneId.Ref"}

### Default catchall ###

  - id:          { $format: "{name}"}
    $source:
      $catchall: {$root: "Resources|squash(@)"}
    type:        {$path: "Type"}
    name:        {$path: "_key"}
    parent:      default-zone

### Skip this stuff ###

  - id:          {$format: "{name}"}
    type:        {$path: "Type"}
    name:        {$path: "_key"}
    $source: 
      $skip:     {$root: "Resources|squash(@)[?Type=='AWS::EC2::VPC']"}

  - id:          {$format: "{name}"}
    type:        {$path: "Type"}
    name:        {$path: "_key"}
    $source:
      $skip:     {$root: "Resources|squash(@)[?Type=='AWS::EC2::RouteTable']"}
  
  - id:          {$format: "{name}"}
    type:        {$path: "Type"}
    name:        {$path: "_key"}
    $source:
      $skip:     {$root: "Resources|squash(@)[?Type=='AWS::EC2::Route']"}

  - id:          {$format: "{name}"}
    type:        {$path: "Type"}
    name:        {$path: "_key"}
    $source:
      $skip:     {$root: "Resources|squash(@)[?Type=='AWS::EC2::SubnetRouteTableAssociation']"}

  - id:          {$format: "{name}"}
    type:        {$path: "Type"}
    name:        {$path: "_key"}
    $source:
      $skip:     {$root: "Resources|squash(@)[?Type=='AWS::EC2::SecurityGroup']"}

  - id:          {$format: "{name}"}
    type:        {$path: "Type"}
    name:        {$path: "_key"}
    $source:
      $skip:     {$root: "Resources|squash(@)[?Type=='AWS::EC2::SecurityGroupIngress']"}

  - id:          {$format: "{name}"}
    type:        {$path: "Type"}
    name:        {$path: "_key"}
    $source:
      $skip:     {$root: "Resources|squash(@)[?Type=='AWS::EC2::VPCEndpoint']"}

  - id:          {$format: "{name}"}
    type:        {$path: "Type"}
    name:        {$path: "_key"}
    $source:
      $skip:     {$root: "Resources|squash(@)[?Type=='AWS::WAFRegional::WebACLAssociation']"}

dataflows:
  - id:          {$format: "{name}-{from_node}-{to_node}"}
    type:        {$path: "Type"}
    name:        {$path: "_key"}
    $source:     {$root: "Resources|squash(@)[?Type=='AWS::WAFRegional::WebACLAssociation']"}
    from:        {$path: "Properties.WebACLId"}
    to:          {$path: "Properties.ResourceArn.Ref"}
